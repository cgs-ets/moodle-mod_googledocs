define ("mod_googledocs/save_grading",["jquery","core/ajax","core/log","core/str","core/notification","mod_googledocs/grading_form_change_check"],function(a,b,c,d,e,f){'use strict';function g(){this}g.prototype.main=function(){var a=this;a.get_users();a.saveGrading()};g.prototype.get_users=function(){var c=a("[data-region=\"user-selector\"]").find("[data-action=change-user]"),d=c.attr("data-googledocid"),f=c.attr("data-groupid");b.call([{methodname:"mod_googledocs_get_participants",args:{googledocid:d,groupid:f},done:this._setUsers.bind(this),fail:e.exception}]);return!0};g.prototype._setUsers=function(a){this.users=JSON.parse(a.users)};g.prototype.saveGrading=function(){var d=this,f;a("input[name=\"savechanges\"").click(function(){f=a(this).attr("name")});a("input[name=\"saveandshownext\"").click(function(){f=a(this).attr("name")});a("#gradeform").on("submit",function(g,e){var h=parseFloat(a("input").first().val());if(isNaN(h)||100<h||0>h){a("#id_error_grade").removeAttr("hidden");g.stopImmediatePropagation();return!1}else{a("#id_error_grade").attr("hidden",!0);a("[data-region=\"overlay\"]").show()}g.preventDefault();var i={userid:a("[data-region=\"user-info\"]").attr("data-userid"),googledocid:a("[data-region=\"user-info\"]").data("googledocid")+"",courseid:a("[data-region=\"googledoc-info\"]").data("courseid")+"",formdata:a(this).serialize()};b.call([{methodname:"mod_googledocs_save_quick_grading",args:{grade:JSON.stringify(i)},done:d._handleFormSubmissionResponse.bind(this,f,e),fail:function fail(a){c.error(a)}}])})};g.prototype._handleFormSubmissionResponse=function(b,c){var h,i=a(".custom-select option:selected").val(),j=a("select.custom-select option:last-child").val();if(c!=void 0){if(c.userid!=void 0){h=c.userid}else if(c.direction.includes("right")){h=a("select.custom-select option:selected").next().val();a(".custom-select option:selected").next().attr("selected","selected")}else if(c.direction.includes("left")){a(".custom-select option:selected").prev().attr("selected","selected");h=a("select.custom-select option").filter(":selected").val()}}else{h=a("select.custom-select option:selected").next().val()}if(0<h){d.get_strings([{key:"changessaved",component:"core"},{key:"gradechangessaveddetail",component:"mod_googledocs"}]).done(function(a){e.alert(a[0],a[1])}).fail(e.exception);if(b!=void 0&&"savechanges"==b){if(""!=a(".grade-input").val()||"0.00"!=a(".grade-input").val()){a("span.gradedtag").removeAttr("hidden");f.saveFormState("#gradeform")}}else{if(h!=void 0&&0<h){a("select.custom-select option[value='".concat(i,"']")).removeAttr("selected");a("select.custom-select option[value='".concat(h,"']")).attr("selected","selected");g.prototype.get_next_user(h,c)}else if(0==h){a(document).trigger("user-changed",h)}}}else if(0!=h&&c!=void 0){window.open(c.direction,"_self")}else{f.saveFormState("#gradeform");console.log(!(b!=void 0&&"savechanges"==b));if(i==j&&!(b!=void 0&&"savechanges"==b)){a("select.custom-select option[value='".concat(i,"']")).removeAttr("selected");console.log("ultimo");h=0;a("select.custom-select option[value='0']").attr("selected","selected");a(document).trigger("user-changed",h);a("div#grading-panel-container").css("display","none")}}a("[data-region=\"overlay\"]").hide()};g.prototype.get_next_user=function(d){var e=a("[data-region=\"user-info\"]").data("googledocid")+"";b.call([{methodname:"mod_googledocs_get_next_participant_details",args:{userid:d,googledocid:e},done:function done(b){c.debug("Grade values retrieved successfuly.");a(document).trigger("user-changed",d);var e=new URL(window.location);e.searchParams.get("userid");e.searchParams.set("userid",d);window.history.replaceState({},"",e);g.prototype.refreshGradePanel(b.html)},fail:function fail(a){c.error("mod_googledocs_get_participant_by_id. Unable to get elements");c.debug(a)}}])};g.prototype.refreshGradePanel=function(b){var c=a("[data-region=\"grade\"]");c.fadeOut(300,function(){c.replaceWith(b);c.show();a("#gradeform").on("submit",g.prototype.saveGrading());f.saveFormState("#gradeform")})};return{init:function(){c.debug("mod_googledocs/SaveGrading: initializing SaveGrading of the mod_googledocs");var a=new g;a.main()}}});
//# sourceMappingURL=save_grading.min.js.map
