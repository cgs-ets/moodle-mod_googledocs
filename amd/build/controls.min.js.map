{"version":3,"sources":["../src/controls.js"],"names":["define","$","Log","Ajax","GoogledocsControl","parentfile_id","create","group_sharing","instance_id","self","prototype","main","callStudentFileService","callGroupFileService","initTags","document","ajaxStop","children","each","tag","find","removeClass","html","addClass","e","attr","tagDisplay","rownumber","creation","by_group","group_id","student_id","student_email","student_name","create_student_file","callStudentFileServiceForByGroup","student_group_id","console","log","call","methodname","args","done","response","debug","url","ref","fail","reason","error","owner_email","group_name","groupid","a_element","create_group_file","googledocid","removeAttr","init","control"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the mod_googledocs/control module\n *\n * @package   mod_googledocs\n * @category  output\n * @copyright 2020 Veronica Bermegui\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_googledocs/control\n */\ndefine(['jquery', 'core/log', 'core/ajax'], function ($, Log, Ajax) {\n    'use strict';\n    /**\n     * Initializes the block controls.\n     */\n    function init(create, group_sharing) {\n        Log.debug('mod_googledocs/control: initializing controls of the mod_googledocs');\n\n        var parentfile_id = $('table.overviewTable').attr('data-googledoc-id');\n        var instance_id = $('table.overviewTable').attr('data-instance-id');\n        var control = new GoogledocsControl(parentfile_id, create, group_sharing, instance_id);\n        control.main();\n    }\n\n    // Constructor.\n    function GoogledocsControl( parentfile_id, create, group_sharing, instance_id) {\n        var self = this;\n        self.parentfile_id = parentfile_id;\n        self.create = create;\n        self.group_sharing = group_sharing;\n        self.instance_id = instance_id;\n    }\n\n    GoogledocsControl.prototype.main = function () {\n        var self = this;\n\n        // Only call the create service if the files are not created.\n        // This JS is called in the view.php page, which calls the function\n        // that renders the table. It is the same table for created and processing\n        //when sharing by group another WS is called\n        if(!self.create && !self.group_sharing) {\n            self.callStudentFileService(self.parentfile_id);\n        }else if (!self.create && self.group_sharing) {\n            self.callGroupFileService();\n        }else{\n              self.initTags();\n        }\n        \n        // When sharing by group or grouping. The same file is shared.\n        // The generation of this file might be quick, but the giving the students\n        // a permission can take sometime. In order for the entire sharing is done\n        // The progress bar is only removed when all the ajax calls finis.\n        $(document).ajaxStop(function() {\n           \n           $('tbody').children().each(function(e){\n            var tag = $(this).find('#status_col');\n            tag.removeClass('progress_bar processing');\n            tag.html('Sharing');\n            tag.addClass('tag_doc success');\n           });\n        });\n\n    };\n\n    GoogledocsControl.prototype.initTags = function (){\n        var self = this;\n        \n        $('tbody').children().each(function(e){\n            if ($('#link_file_' + e).attr('href') != '#'){\n                self.tagDisplay(e, true);\n            }else{\n                self.tagDisplay(e, false);\n            }\n        });\n\n    };\n\n\n    /**\n     *\n     * @param {int} rownumber\n     * @param  boolean creation\n     * @returns display created or failed on the table's status column.\n     */\n    GoogledocsControl.prototype.tagDisplay = function(rownumber, creation){\n        var self = this;\n \n        if(creation === true && !self.group_sharing){\n            $('#file_' + rownumber).html('Created');\n            $('#file_' + rownumber).addClass('tag_doc success');\n        }else if(creation === true && self.group_sharing){\n            $('div#status_col').html('Sharing');\n            $('div#status_col').addClass('tag_doc success');\n        }else{\n            $('#file_' + rownumber).html('Failed');\n            $('#file_' + rownumber).addClass('tag_doc failed');\n        }\n\n    };\n\n    GoogledocsControl.prototype.callStudentFileService = function(parentfile_id, by_group = false, group_id = 0){\n        var self = this;\n\n        $('tbody').children().each(function(e){\n            var student_id = $(this).attr('data-student-id');  \n            var student_email = $(this).attr('data-student-email');\n            var student_name = $(this).attr('student-name');\n            self.create_student_file(e, student_id, student_email, student_name, parentfile_id);\n\n        });\n    };\n\n    GoogledocsControl.prototype.callStudentFileServiceForByGroup = function(parentfile_id, group_id) {\n        var self = this;\n        $('tbody#group-members-'+group_id).children().each(function(e){\n            \n            var student_id = $(this).attr('data-student-id');\n            var student_email = $(this).attr('data-student-email');\n            var student_name = $(this).attr('student-name');\n            var student_group_id = $(this).attr('student-group-id');\n            \n            console.log('student id: ' +student_id);\n            \n            if(student_group_id == group_id) {\n                self.create_student_file(e, student_id, student_email, student_name, parentfile_id, true, student_group_id);\n            }\n\n        });\n\n    };\n\n    GoogledocsControl.prototype.create_student_file = function (rownumber, student_id, student_email,student_name, parentfile_id, \n                                                                by_group = false, student_group_id = 0) {\n        var self = this;\n\n        if(!by_group) {\n           $('#file_' + rownumber).addClass('progress_bar processing'); // progress bar visible.\n        }\n\n        Ajax.call([{\n                methodname: 'mod_googledocs_create_students_file',\n                args: {\n                    by_group : by_group,\n                    group_id : student_group_id,\n                    instance_id : self.instance_id,\n                    parentfile_id: parentfile_id,\n                    student_email: student_email,\n                    student_id: student_id,\n                    student_name: student_name\n                },\n                done: function (response) {\n                    Log.debug(response.url);\n                    console.log(\"rownumber: \" + rownumber );\n                    // Add file's link\n                    var ref = $('#' + 'link_file_' + rownumber);\n                    $(ref).attr(\"href\", response.url);\n                    // Remove progress bar and display status\n                    if(!by_group) {\n                        $('#file_' + rownumber).removeClass('progress_bar processing');\n                        self.tagDisplay(rownumber, true);\n                    }\n                },\n                fail: function (reason) {\n                    Log.error(reason);\n                    $('#file_' + rownumber).removeClass('progress_bar  processing');\n                    self.tagDisplay(rownumber, false);\n                }\n            }]);\n      \n    };\n\n    GoogledocsControl.prototype.callGroupFileService = function (){\n\n        var owner_email = $('table.overviewTable').attr('data-owner-email');\n        var self = this;\n        $('tbody').find('[data-group-name]').each(function(e){\n            var group_name = $(this).attr('data-group-name');\n            var groupid =   $(this).attr('data-group-id'); \n            var a_element = ($(this).find('#shared_link_url_' + groupid))[0]; //It is always the one element.\n           ($(this).find('div#status_col')).addClass('progress_bar processing');\n            self.create_group_file(a_element, owner_email, group_name, groupid);\n            //(($(this).find('div#status_col'))).removeClass('progress_bar processing');\n        });\n\n    };\n\n    GoogledocsControl.prototype.create_group_file = function(a_element ,owner_email, group_name, group_id){\n\n        var self = this;\n      \n        Ajax.call([{\n            methodname: 'mod_googledocs_create_group_file',\n            args: {\n                group_name: group_name,\n                group_id: group_id,\n                owner_email: owner_email,\n                parentfile_id: self.parentfile_id,\n            },\n            done: function (response) {\n                console.log(response);\n                 // Add file's link\n                $(a_element).attr(\"href\", response.url);\n                //Returns the ID of the file created for the group.\n                //$(this).find('div#status_col').removeClass('progress_bar processing');\n                self.callStudentFileServiceForByGroup(response.googledocid, group_id);\n\n            },\n            fail: function (reason) {\n                Log.error(reason);\n            }\n        }]);\n\n        $('table.overviewTable').removeAttr('data-googledoc-id');\n\n    };\n\n        return {\n            init: init\n        };\n });"],"file":"controls.min.js"}