{"version":3,"sources":["../src/save_grading.js"],"names":["define","$","Ajax","Log","str","notification","Checker","GoogledocSaveGrading","prototype","main","self","get_users","saveGrading","select","find","googledocid","attr","groupid","call","methodname","args","done","_setUsers","bind","fail","exception","users","JSON","parse","buttonpressed","click","on","e","navigation","gradeval","parseFloat","first","val","isNaN","removeAttr","stopImmediatePropagation","show","preventDefault","grade","userid","data","courseid","formdata","serialize","stringify","_handleFormSubmissionResponse","reason","error","nav","nextUserId","currentSelectionid","lastSelectElement","direction","includes","next","prev","filter","saveFormState","get_next_user","document","trigger","window","open","css","hide","nextuserid","response","debug","url","URL","location","searchParams","get","set","history","replaceState","refreshGradePanel","html","htmlResult","region","fadeOut","replaceWith","init","control"],"mappings":"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","sourcesContent":["// Standard license block omitted.\n/*\n * @package    mod_googledocs\n * @copyright  2020 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_googledocs/update_controls\n *\n */\ndefine(['jquery', 'core/ajax', 'core/log', 'core/str', 'core/notification', 'mod_googledocs/grading_form_change_check'], function ($, Ajax, Log, str, notification, Checker) {\n    'use strict';\n    /**\n     * Initializes the update controls.\n     */\n    function init() {\n        Log.debug('mod_googledocs/SaveGrading: initializing SaveGrading of the mod_googledocs');\n        var control = new GoogledocSaveGrading();\n        control.main();\n    }\n\n    // Constructor\n    function GoogledocSaveGrading() {\n        var self = this;\n    }\n    ;\n\n    GoogledocSaveGrading.prototype.main = function () {\n        var self = this;\n        self.get_users();\n        self.saveGrading();\n    };\n\n    GoogledocSaveGrading.prototype.get_users = function () {\n        var select = $('[data-region=\"user-selector\"]').find('[data-action=change-user]');\n        var googledocid = select.attr('data-googledocid');\n        var groupid = select.attr('data-groupid');\n\n        Ajax.call([{\n                methodname: 'mod_googledocs_get_participants',\n                args: {googledocid: googledocid, groupid: groupid},\n                done: this._setUsers.bind(this),\n                fail: notification.exception\n            }]);\n\n        return true;\n    };\n\n    GoogledocSaveGrading.prototype._setUsers = function (users) {\n        this.users = JSON.parse(users.users);\n    };\n\n    GoogledocSaveGrading.prototype.saveGrading = function () {\n        var self = this;\n        var buttonpressed;\n\n        $('input[name=\"savechanges\"').click(function () {\n            buttonpressed = $(this).attr('name');\n        });\n\n        $('input[name=\"saveandshownext\"').click(function () {\n            buttonpressed = $(this).attr('name');\n        });\n\n        $(\"#gradeform\").on('submit', function (e, navigation) {\n\n            var gradeval = parseFloat($('input').first().val());\n\n            if (isNaN(gradeval) || gradeval > 100 || gradeval < 0) {\n                $(\"#id_error_grade\").removeAttr('hidden');\n                e.stopImmediatePropagation();\n                return false;\n            } else {\n                $(\"#id_error_grade\").attr('hidden', true);\n                $('[data-region=\"overlay\"]').show();\n            }\n            e.preventDefault();\n\n            var grade = {\n                userid: $('[data-region=\"user-info\"]').attr('data-userid'), //data returns old values\n                googledocid: String($('[data-region=\"user-info\"]').data('googledocid')),\n                courseid: String($('[data-region=\"googledoc-info\"]').data('courseid')),\n                formdata: $(this).serialize()\n            };\n\n            Ajax.call([{\n                    methodname: 'mod_googledocs_save_quick_grading',\n                    args: {\n                        grade: JSON.stringify(grade),\n                    },\n                    done: self._handleFormSubmissionResponse.bind(this, buttonpressed, navigation),\n                    fail: function (reason) {\n                        Log.error(reason);\n                    }\n                }]);\n        });\n\n    };\n\n    GoogledocSaveGrading.prototype._handleFormSubmissionResponse = function (formdata, nav) {\n        var nextUserId;\n        var currentSelectionid = $('.custom-select option:selected').val();\n        var lastSelectElement = $('select.custom-select option:last-child').val();\n        var isLast = (currentSelectionid == lastSelectElement);\n\n        if (nav != undefined) {\n            if (nav.userid != undefined) {\n                nextUserId = nav.userid;\n            } else if (nav.direction.includes('right')) {\n                nextUserId = $('select.custom-select option:selected').next().val();\n                $('.custom-select option:selected').next().attr('selected', 'selected');\n            } else if (nav.direction.includes('left')) {\n                $('.custom-select option:selected').prev().attr('selected', 'selected');\n                nextUserId = $(\"select.custom-select option\").filter(\":selected\").val();\n            }\n        } else { // clicked on save and show next\n            nextUserId = $('select.custom-select option:selected').next().val();\n        }\n\n        if (nextUserId > 0) {\n            \n            if (formdata != undefined && formdata == 'savechanges') {\n                if ($('.grade-input').val() != '' || $('.grade-input').val() != '0.00') {\n                    $('span.gradedtag').removeAttr('hidden');\n                    Checker.saveFormState('#gradeform'); // Save new form state.\n                }\n            } else {\n                if (nextUserId != undefined && nextUserId > 0) {  // it's coming from the navigation\n                    $(`select.custom-select option[value='${currentSelectionid}']`).removeAttr('selected');\n                    $(`select.custom-select option[value='${nextUserId}']`).attr('selected', 'selected'); // chance selection\n                    GoogledocSaveGrading.prototype.get_next_user(nextUserId, nav);\n                } else if (nextUserId == 0) {\n                    $(document).trigger('user-changed', nextUserId);\n                }\n            }\n        } else if (nextUserId != 0 && nav != undefined) {  // clicked on a link \n            window.open(nav.direction, \"_self\");\n        } else {\n            Checker.saveFormState('#gradeform'); // Save new form state          \n            if (isLast && !(formdata != undefined && formdata == 'savechanges')) {\n                $(`select.custom-select option[value='${currentSelectionid}']`).removeAttr('selected');               \n                nextUserId = 0;\n                $(\"select.custom-select option[value='0']\").attr('selected', 'selected');\n                $(document).trigger('user-changed', nextUserId);\n                $(\"div#grading-panel-container\").css('display', 'none');\n            }\n\n        }\n\n        $('[data-region=\"overlay\"]').hide();\n    };\n\n    GoogledocSaveGrading.prototype.get_next_user = function (nextuserid, nav) {\n\n        var googledocid = String($('[data-region=\"user-info\"]').data('googledocid'))\n\n        Ajax.call([{\n                methodname: 'mod_googledocs_get_next_participant_details',\n                args: {\n                    userid: nextuserid,\n                    googledocid: googledocid\n                },\n                done: function (response) {\n                    Log.debug(('Grade values retrieved successfuly.'));\n                    $(document).trigger('user-changed', nextuserid);   // Refresh name\n                    var url = new URL(window.location); //refresh url\n                    url.searchParams.get('userid');\n                    url.searchParams.set('userid', nextuserid);\n                    // We do this so a browser refresh will return to the same user.\n                    window.history.replaceState({}, \"\", url);\n\n                    GoogledocSaveGrading.prototype.refreshGradePanel(response.html);\n                },\n                fail: function (reason) {\n                    Log.error('mod_googledocs_get_participant_by_id. Unable to get elements');\n                    Log.debug(reason);\n                }\n            }]);\n    };\n\n    GoogledocSaveGrading.prototype.refreshGradePanel = function (htmlResult) {\n        var region = $('[data-region=\"grade\"]');\n\n        region.fadeOut(300, function () {\n            region.replaceWith(htmlResult);\n            region.show();\n            $(\"#gradeform\").on('submit', GoogledocSaveGrading.prototype.saveGrading()); //reattach the event\n            Checker.saveFormState('#gradeform');\n        });\n    };\n\n\n    return {\n        init: init\n    };\n});"],"file":"save_grading.min.js"}