{"version":3,"sources":["../src/save_grading.js"],"names":["define","$","Ajax","Log","str","notification","GoogledocSaveGrading","prototype","main","self","get_users","saveGrading","select","find","googledocid","attr","groupid","call","methodname","args","done","_setUsers","bind","fail","exception","users","JSON","parse","buttonpressed","click","on","e","show","preventDefault","grade","userid","data","courseid","formdata","serialize","stringify","_handleFormSubmissionResponse","reason","error","savegradingobject","response","nextUserId","next","val","console","log","get_strings","key","component","strs","alert","removeAttr","get_next_user","hide","nextuserid","savegradingref","currentuserid","debug","document","trigger","url","URL","window","location","searchParams","get","set","history","replaceState","refreshGradePanel","html","htmlResult","region","fadeOut","replaceWith","init","control"],"mappings":"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","sourcesContent":["// Standard license block omitted.\n/*\n * @package    mod_googledocs\n * @copyright  2020 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n \n /**\n  * @module mod_googledocs/update_controls\n  * \n  */\ndefine(['jquery', 'core/ajax', 'core/log','core/str', 'core/notification'], \n    function($, Ajax, Log, str, notification) {\n  'use strict';\n    /**\n     * Initializes the update controls.\n     */\n    function init() {\n        Log.debug('mod_googledocs/SaveGrading: initializing SaveGrading of the mod_googledocs');\n        var control = new GoogledocSaveGrading();\n        control.main();\n    }\n\n    // Constructor\n    function GoogledocSaveGrading (){\n        var self = this;\n    };\n\n\n    GoogledocSaveGrading.prototype.main = function() {\n        var self = this;\n        self.get_users();\n        self.saveGrading();\n    };\n    GoogledocSaveGrading.prototype.get_users = function() {\n        var select = $('[data-region=\"user-selector\"]').find('[data-action=change-user]');  \n        var googledocid = select.attr('data-googledocid');\n        var groupid = select.attr('data-groupid');\n\n        Ajax.call([{\n            methodname: 'mod_googledocs_get_participants',\n            args: {googledocid: googledocid, groupid: groupid},\n            done: this._setUsers.bind(this),\n            fail: notification.exception\n        }]);\n        return true;\n    };\n\n    GoogledocSaveGrading.prototype._setUsers = function(users) {\n        this.users = JSON.parse(users.users);\n    };\n\n    GoogledocSaveGrading.prototype.saveGrading = function() {\n        var self = this; \n        var buttonpressed;\n\n        $('input[name=\"savechanges\"').click(function() {\n            buttonpressed = $(this).attr('name');\n        });\n        $('input[name=\"saveandshownext\"').click(function() {\n            buttonpressed = $(this).attr('name');\n        });\n\n        $(\"#gradeform\").on('submit', function (e) {\n            $('[data-region=\"overlay\"]').show();\n            e.preventDefault();\n\n            var grade = {\n                userid : $('[data-region=\"user-info\"]').attr('data-userid'), //data returns old values\n                googledocid: String($('[data-region=\"user-info\"]').data('googledocid')),\n                courseid: String($('[data-region=\"googledoc-info\"]').data('courseid')),\n                formdata: $(this).serialize()\n            };\n\n            Ajax.call([{\n                methodname: 'mod_googledocs_save_quick_grading',\n                args: {\n                    grade : JSON.stringify(grade),\n                },\n                done: self._handleFormSubmissionResponse.bind(this, buttonpressed, self),\n                fail: function (reason) {\n                        Log.error(reason);\n                    }\n            }]);\n        });\n\n    };\n\n    GoogledocSaveGrading.prototype._handleFormSubmissionResponse = function(formdata, savegradingobject, response) {\n\n        var nextUserId = $('select.custom-select option:selected').next().val();\n        console.log(response);\n       \n        str.get_strings([\n            {key: 'changessaved', component: 'core'},\n            {key: 'gradechangessaveddetail', component: 'mod_googledocs'},\n        ]).done(function(strs) {\n            notification.alert(strs[0], strs[1]);\n        }).fail(notification.exception);\n        \n        if (formdata == 'savechanges') {\n            if ($('.grade-input').val() != '' || $('.grade-input').val() !='0.00') {\n                $('span.gradedtag').removeAttr('hidden');\n            }\n//            $('.textarea-comment').val('');\n//            $('.grade-input').val('');\n        } else {\n           savegradingobject.get_next_user(nextUserId, savegradingobject); \n        }\n\n        $('[data-region=\"overlay\"]').hide();\n    };\n    \n    GoogledocSaveGrading.prototype.get_next_user = function (nextuserid, savegradingref) {\n        var currentuserid = $('[data-region=\"user-info\"]').attr('data-userid');\n        var googledocid = String($('[data-region=\"user-info\"]').data('googledocid'))\n         Ajax.call([{\n            methodname: 'mod_googledocs_get_next_participant_details',\n            args: {\n                    userid : nextuserid,\n                    googledocid: googledocid\n                },\n            done:function(response){\n                    Log.debug(('Grade values retrieved successfuly.'));\n                    $(document).trigger('user-changed', nextuserid);   // Refresh name\n                    $('select.custom-select option:selected').next().attr('selected', 'selected');\n                    $(`select.custom-select option[value='${currentuserid}']`).removeAttr('selected'); // Refresh select                  \n                    var url = new URL(window.location); //refresh url\n                    url.searchParams.get('userid');\n                    url.searchParams.set('userid', nextuserid);\n                    // We do this so a browser refresh will return to the same user.\n                    window.history.replaceState({}, \"\", url);\n\n                    savegradingref.refreshGradePanel(response.html);\n            },\n           fail: function(reason) {\n                Log.error('mod_googledocs_get_participant_by_id. Unable to get elements');\n                Log.debug(reason);\n            }\n        }]);\n    };\n\n    GoogledocSaveGrading.prototype.refreshGradePanel = function (htmlResult) {\n        var region = $('[data-region=\"grade\"]');\n\n        region.fadeOut(300, function() {\n            region.replaceWith(htmlResult);\n            region.show();\n            $(\"#gradeform\").on('submit', GoogledocSaveGrading.prototype.saveGrading()); //Re-attach the event\n        });\n    };\n    \n\n    return {\n        init: init\n    };\n});"],"file":"save_grading.min.js"}