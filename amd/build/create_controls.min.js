define ("mod_googledocs/create_controls",["jquery","core/log","core/ajax","mod_googledocs/delete_controls","mod_googledocs/update_controls"],function(a,b,c,d,e){'use strict';function f(a,b,c,d,e,f,g){var h=this;h.parentfile_id=a;h.create=b;h.instance_id=c;h.files_to_erase=d;h.countCalls=e;h.dist_type=f;h.group_folder_ids=g}f.prototype.main=function(){var b=this;window.addEventListener("popstate",b.popstateHandler);if(!b.create){window.addEventListener("beforeunload",b.beforeunloadHandler)}else{window.removeEventListener("beforeunload",b.beforeunloadHandler,!1)}b.initTags();switch(b.dist_type){case"std_copy":if(!b.create){b.callStudentFileService(b.parentfile_id)}break;case"group_copy":if(!b.create){b.callGroupFileService()}break;case"grouping_copy":b.initGroupingTags();if(!b.create){b.callGroupingFileService()}break;case"std_copy_group":if(!b.create){b.create_group_folder()}break;case"dist_share_same":if(!b.create){b.callStudentFileService(b.parentfile_id)}break;case"dist_share_same_group":if(!b.create){b.shareSameGroupGroupingService()}break;case"dist_share_same_grouping":if(!b.create){b.callGroupingFileService(b.parentfile_id)}break;case"std_copy_grouping":if(!b.create){b.create_group_folder()}break;case"std_copy_group_grouping":if(!b.create){b.create_group_folder()}break;case"group_grouping_copy":if(!b.create){b.callGroupGroupingFileService()}else{b.initGGTags()}break;case"dist_share_same_group_grouping":if(!b.create){b.callGroupGroupingFileService()}else{b.initGGTags()}break;}a(document).ajaxStop(function(){a("tbody").children().each(function(){var b=a(this).find("#status_col");b.removeClass("spinner-border color");b.html("Created");b.addClass("tag_doc success")});var c=a("table.overviewTable").attr("data-from-existing");if("grouping_copy"==b.dist_type){a("tbody.grouping-groups td.groups").each(function(){a(this).find("table").each(function(){var b=a(this).find("#file_grouping");b.removeClass("spinner-border color");b.html("Created");b.addClass("tag_doc success")})});if(0<b.files_to_erase.length&&0==c){b.delete_file_from_grouping();b.files_to_erase=[]}}var f=a("tbody").children().length,g=a("table.overviewTable").attr("data-googledocs-id");a("table.overviewTable").removeAttr("data-googledocs-id");if(1==c&&b.countCalls==f&&g!=void 0){b.files_to_erase.push(g);e.init(JSON.stringify(b.files_to_erase));b.countCalls=0}if("group_grouping_copy"==b.dist_type&&b.countCalls==f){b.files_to_erase.push(g);d.init(JSON.stringify(b.files_to_erase),b.dist_type);b.countCalls=0}if(b.countCalls==f&&g!=void 0&&0==c&&"grouping_copy"!=b.dist_type){b.files_to_erase.push(g);d.init(JSON.stringify(b.files_to_erase),b.dist_type);b.countCalls=0}})};f.prototype.beforeunloadHandler=function(a){a.preventDefault();a.returnValue=""};f.prototype.popstateHandler=function(){b.debug("popstateHandler")};f.prototype.initTags=function(){var b=this;a("tbody").children().each(function(c){if("#"!=a("#link_file_"+c).attr("href")){b.tagDisplay(c,b.create)}else{b.tagDisplay(c,b.create)}})};f.prototype.initGGTags=function(){a("tbody").find("[data-g-name]").each(function(){var b=a(this).attr("data-g-id"),c=a(this).find("div#status_col_"+b);a(c).html("Created");a(c).addClass("tag_doc success")})};f.prototype.initGroupingTags=function(){var b=this;a("tbody").find("[data-grouping-name]").each(function(){var c=a(this).attr("data-grouping-id"),d=a(this).find("div#status_col_"+c);if(b.create){a(d).html("Created");a(d).addClass("tag_doc success")}else{a("div#status_col_"+c).addClass("spinner-border color")}})};f.prototype.tagDisplay=function(b,c){if(!0===c){a("#file_"+b).html("Created");a("#file_"+b).addClass("tag_doc success")}else{a("#file_"+b).addClass("spinner-border color")}};f.prototype.failedTag=function(b){a("#file_"+b).html("Failed")};f.prototype.delete_file_from_grouping=function(){var a=this;d.init(JSON.stringify(a.files_to_erase),a.dist_type);a.files_to_erase=[];a.countCalls=0};f.prototype.callStudentFileService=function(c){var d=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,f=this;b.debug("callStudentFileService");a("tbody").children().each(function(b){var d=a(this).attr("data-student-id"),e=a(this).attr("data-student-email"),g=a(this).attr("student-name"),h;if("dist_share_same_grouping"==f.dist||"std_copy_grouping"==f.dist){h=a(this).attr("student-grouping-id")}else{h=a(this).attr("student-group-id")}f.create_student_file(b,d,e,g,c,h)})};f.prototype.callStudentFileServiceForGroup=function(c,d){var f=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,g=this;b.debug("Enters to: callStudentFileServiceForGroup");b.debug("Parent file ID "+c+"Group ID "+d+"Grouping ID "+f);a("tbody#group-members-"+d).children().each(function(b){var e=a(this).attr("data-student-id"),h=a(this).attr("data-student-email"),i=a(this).attr("student-name"),j=a(this).attr("student-group-id");if(j==d){g.create_student_file(b,e,h,i,c,j,f)}})};f.prototype.create_student_file=function(d,e,f,g,h){var i=5<arguments.length&&arguments[5]!==void 0?arguments[5]:0,j=6<arguments.length&&arguments[6]!==void 0?arguments[6]:0,k=this,l=0;if("group_copy"!=k.dist_type){a("#file_"+d).addClass("spinner-border color")}if("std_copy_group"==k.dist_type||"std_copy_grouping"==k.dist_type||"std_copy_group_grouping"==k.dist_type){l=k.get_group_folder_id(i,k.group_folder_ids);b.debug("create_student_file student_name = "+g);b.debug("create_student_file folder_id = "+l)}c.call([{methodname:"mod_googledocs_create_students_file",args:{folder_group_id:l,group_id:i,grouping_id:j,instance_id:k.instance_id,parentfile_id:h,student_email:f,student_id:e,student_name:g},done:function done(c){b.debug(c.url);k.countCalls++;var e=JSON.parse(c.url);if("std_copy_group"==k.dist_type||"std_copy_grouping"==k.dist_type||"std_copy_group_grouping"==k.dist_type){k.renderStudentLinks(e,d)}else{var f=a("#link_file_"+d);a(f).attr("href",e[0])}if("group_copy"!=k.dist_type){a("#file_"+d).removeClass("spinner-border color");k.tagDisplay(d,!0)}},fail:function fail(c){b.error(c);a("#file_"+d).removeClass("spinner-border color");k.failedTag(d)}}])};f.prototype.renderStudentLinks=function(c,d){c.forEach(function(c,e){b.debug("addLinks "+d);var f=a("#link_file_"+d);if(0===e){a(f).attr("href",c)}else{var g=a(f).find("img").attr("src");a(f).append("<a target=\"_blank\" id=\"link_file_"+d+"\"href=\""+c+"\" class=\"link_icon\">\n                            <img src=\""+g+"\" class=\"link_icon\"</a>")}},d)};f.prototype.callGroupFileService=function(){var b=a("table.overviewTable").attr("data-owner-email"),c=this;a("tbody").find("[data-group-name]").each(function(){c.countCalls++;var d=a(this).attr("data-group-name"),e=a(this).attr("data-group-id"),f=a(this).find("#shared_link_url_"+e)[0];a(this).find("div#status_col").addClass("spinner-border color");c.create_group_file(f,b,d,e)})};f.prototype.callGroupingFileService=function(){var b=this,c=a("table.overviewTable ").attr("data-owner-email");b.create_grouping_file(c)};f.prototype.callGroupGroupingFileService=function(){var b=a("table.overviewTable").attr("data-owner-email"),c=a("table.overviewTable").attr("data-instance-id"),d=this;a("tbody").find("[data-g-name]").each(function(){d.countCalls++;var e=a(this).attr("data-g-name"),f=a(this).attr("data-g-id"),g=a(this).attr("data-g-type"),h=a(this).find("#shared_link_url_"+f)[0],i=a(this).find("#status_col_"+f);a(this).find("div#status_col_"+f).addClass("spinner-border color");d.create_group_grouping_file(h,i,b,c,e,f,g)})};f.prototype.create_group_file=function(){var d=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"",e=1<arguments.length?arguments[1]:void 0,f=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"",g=3<arguments.length?arguments[3]:void 0,h=4<arguments.length&&arguments[4]!==void 0?arguments[4]:0,i=5<arguments.length&&arguments[5]!==void 0?arguments[5]:0,j=this;if(!j.grouping_sharing){h=j.parentfile_id}c.call([{methodname:"mod_googledocs_create_group_file",args:{group_name:f,group_id:g,grouping_id:i,instance_id:j.instance_id,owner_email:e,parentfile_id:h},done:function done(c){b.debug("mod_googledocs_create_group_file "+c);if("dist_share_same_group"==j.dist_type||"dist_share_same_grouping_copy"==j.dist_type||"dist_share_same_group_grouping_copy"==j.dist_type){j.append_links_to_icons(c.url)}else{a(d).attr("href",c.url);b.debug("Group ID"+g);j.callStudentFileServiceForGroup(c.googledocid,g)}j.files_to_erase.push(h)},fail:function fail(a){b.error(a)}}])};f.prototype.create_grouping_file=function(d){var f=this;b.debug("create_grouping_file llamada");c.call([{methodname:"mod_googledocs_create_grouping_file",args:{owneremail:d,parentfileid:f.parentfile_id},done:function done(c){if("grouping_copy"==f.dist_type){b.debug(c);a("tbody tr").each(function(){var b=a(this).attr("data-grouping-id");f.get_grouping_url(b,JSON.parse(c.groupingsurl))})}else{a("tbody tr").each(function(b){var d=a(this).attr("student-grouping-id");f.get_grouping_url_for_student(d,JSON.parse(c.groupingsurl),b)})}},fail:function fail(a){b.error(a)}}])};f.prototype.create_group_grouping_file=function(){var d=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"",e=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"",f=2<arguments.length?arguments[2]:void 0,g=3<arguments.length?arguments[3]:void 0,h=4<arguments.length?arguments[4]:void 0,i=5<arguments.length?arguments[5]:void 0,j=6<arguments.length?arguments[6]:void 0,k=this;c.call([{methodname:"mod_googledocs_create_group_grouping_file",args:{gid:i,gname:h,gtype:j,instanceid:g,owneremail:f,parentfileid:k.parentfile_id},done:function done(b){a(d).attr("href",b.url);a(e).removeClass("spinner-border color");a(e).html("Created");a(e).addClass("tag_doc success")},fail:function fail(a){b.error(a)}}])};f.prototype.create_group_folder=function(){var d=this;b.debug("create_group_folder "+d.instance_id);c.call([{methodname:"mod_googledocs_create_group_folder_struct",args:{instanceid:d.instance_id},done:function done(c){b.debug("mod_googledocs_create_group_folder_struct");d.group_folder_ids=JSON.parse(c.group_folder_ids);if("std_copy_group"==d.dist_type||"std_copy_grouping"==d.dist_type||"std_copy_group_grouping"==d.dist_type){d.callStudentFileService(d.parentfile_id)}if("dist_share_same_group"==d.dist_type||"dist_share_same_grouping_copy"==d.dist_type||"dist_share_same_group_grouping_copy"==d.dist_type){var e=a("table.overviewTable").attr("data-all-groups"),f=a("table.overviewTable").attr("data-owner-email");d.create_group_file("",f,"",e,d.parentfile_id)}},fail:function fail(a){b.error(a)}}])};f.prototype.shareSameGroupGroupingService=function(){var b=this,c=a("table.overviewTable").attr("data-all-groups"),d=a("table.overviewTable").attr("data-owner-email");b.create_group_file("",d,"",c,b.parentfile_id)};f.prototype.get_group_folder_id=function(a,b){for(var c=a.split("-"),d=0;d<b.length;d++){if(b[d].group_id==a||c.includes(b[d].group_id)){return b[d].folder_id}}};f.prototype.get_grouping_url_for_student=function(a,c,d){for(var e=a.split("-"),f=[],g=this,h=0;h<c.length;h++){if(e.includes(c[h].gid)){f.push(c[h].url)}}b.debug(f);g.append_links_helper(f,d)};f.prototype.get_grouping_url=function(b,c){for(var d=a("#shared_link_url_"+b),e=0;e<c.length;e++){if(b==c[e].gid){a(d).attr("href",c[e].url);var f=a("#status_col_"+b);f.removeClass("spinner-border color");f.html("Created");f.addClass("tag_doc success");break}}};f.prototype.append_links_to_icons=function(c){var d=this;a("tbody").children().each(function(f){d.countCalls++;b.debug("append_links_to_icons");var e=a(this).attr("student-group-id");d.get_grouping_url_for_student(e,JSON.parse(c),f)})};f.prototype.append_links_helper=function(b,c){var d=this;console.log("append_links_helper");console.log(b);b.forEach(function(b,e){console.log("LA URL ES: "+b);var f=a("#link_file_"+c),g=a(f).find("img").attr("src");if(0==e){a(f).attr("href",b)}else{a(f).append("<a target=\"_blank\" id=\"link_file_"+c+"\"href=\""+b+"\" class=\"link_icon\">\n \n                <img src=\""+g+"\" class=\"link_icon\"</a>")}a("#file_"+c).removeClass("spinner-border color");d.tagDisplay(c,!0)})};return{init:function(c,d){b.debug("mod_googledocs/update_control: initializing of the mod_googledocs control");b.debug(d);var e=a("table.overviewTable").attr("data-googledocs-id"),g=a("table.overviewTable").attr("data-instance-id"),h,i=new f(e,c,g,[],0,d,h);i.main()}}});
//# sourceMappingURL=create_controls.min.js.map
