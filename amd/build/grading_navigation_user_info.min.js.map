{"version":3,"sources":["../src/grading_navigation_user_info.js"],"names":["define","$","notification","ajax","templates","UserInfo","selector","console","log","_regionSelector","_region","_userCache","_userid","data","_refreshUserInfo","_refreshUserSelector","document","on","bind","prototype","_lastUserId","_getGoogledocId","attr","event","userid","promise","Deferred","render","done","html","js","fadeOut","replaceNodeContents","fadeIn","fail","exception","resolve","googledocid","requests","call","methodname","args","participant","hasOwnProperty","reject","context","courseid","user","identity","email","profileimageurl"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"User summary\" panel at the top of the page.\n *\n * @module     mod_googledocs/grading_navigation_user_info\n * @package    mod_googledocs\n * @class      UserInfo\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/templates'], function($, notification, ajax, templates) {\n\n    /**\n     * UserInfo class.\n     *\n     * @class UserInfo\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var UserInfo = function(selector) {\n        console.log('UserInfo starts');\n        console.log(selector);\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._userCache = [];\n\n        if (selector == '[data-region=\"user-info\"]') {\n            this._userid = $('[data-region=\"user-info\"]').data('userid');\n            this._refreshUserInfo('e', this._userid);\n            this._refreshUserSelector(); \n        }\n        $(document).on('user-changed', this._refreshUserInfo.bind(this));        \n    };\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    UserInfo.prototype._regionSelector = null;\n\n    /** @type {Array} Cache of user info contexts. */\n    UserInfo.prototype._userCache = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    UserInfo.prototype._region = null;\n\n    /** @type {Integer} Remember the last user id to prevent unnecessary reloads. */\n    UserInfo.prototype._lastUserId = 0;\n\n    UserInfo.prototype._userid = 0;\n\n    /**\n     * Get the googledocsment id\n     *\n     * @private\n     * @method _getGoogledocId\n     * @return {Integer} googledocsment id\n     */\n    UserInfo.prototype._getGoogledocId = function() {\n        return this._region.attr('data-googledocid');\n    };\n\n    UserInfo.prototype._refreshUserSelector = function () {\n        $(`select.custom-select option[value='${this._userid}']`).attr('selected', 'selected');\n    }\n\n    /**\n     * Get the user context - re-render the template in the page.\n     *\n     * @private\n     * @method _refreshUserInfo\n     * @param {Event} event\n     * @param {Number} userid\n     */\n    UserInfo.prototype._refreshUserInfo = function(event, userid) {\n        var promise = $.Deferred();\n        console.log('_refreshUserInfo') ;\n        console.log(userid);\n        console.log('_lastUserId: ');\n        console.log(this._lastUserId);\n        // Put the current user ID in the DOM so yui can access it.\n        this._region.attr('data-userid', userid);\n        \n        // Skip reloading if it is the same user.\n        if (this._lastUserId == userid) {\n            return;\n        }\n        this._lastUserId = userid;\n\n        // First insert the loading template.     \n        templates.render('mod_googledocs/loading', {}).done(function(html, js) {\n            // Update the page.\n            this._region.fadeOut(\"fast\", function() {\n                templates.replaceNodeContents(this._region, html, js);\n                this._region.fadeIn(\"fast\");\n            }.bind(this));\n\n            if (userid < 0) {\n                // Render the template.\n                templates.render('mod_googledocs/grading_navigation_no_users', {}).done(function(html, js) {\n                    if (userid == this._lastUserId) {\n                        // Update the page.\n                        this._region.fadeOut(\"fast\", function() {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }\n                }.bind(this)).fail(notification.exception);\n                return;\n            }\n\n            if (typeof this._userCache[userid] !== \"undefined\") {\n                promise.resolve(this._userCache[userid]);\n            } else {\n                // Load context from ajax.\n                var googledocid = this._getGoogledocId();  \n                var requests = ajax.call([{\n                    methodname: 'mod_googledocs_get_participant',\n                    args: {\n                        userid : userid,\n                        googledocid: googledocid\n                    }\n                }]);\n\n                requests[0].done(function(participant) {\n                    if (!participant.hasOwnProperty('id')) {\n                        promise.reject('No users');\n                    } else {\n                        this._userCache[userid] = participant;\n                        promise.resolve(this._userCache[userid]);\n                    }\n                }.bind(this)).fail(notification.exception); \n            }\n\n            promise.done(function(context) {\n                context.courseid = $('[data-region=\"grading-navigation-panel\"]').attr('data-courseid');\n                if (context.user) {\n                    context.identity =context.user.email;\n                    // Add profile image url to context.\n                    if (context.user.profileimageurl) {\n                        context.profileimageurl = context.user.profileimageurl;\n                    }\n                }\n\n                templates.render('mod_googledocs/grading_navigation_user_summary', context).done(function(html, js) {\n                    // Update the page.\n                    if (userid == this._lastUserId) {\n                        this._region.fadeOut(\"fast\", function() {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }\n                }.bind(this)).fail(notification.exception);\n            }.bind(this)).fail(function() {\n                // Render the template.\n                templates.render('mod_googledocs/grading_navigation_no_users', {}).done(function(html, js) {\n                    // Update the page.\n                    this._region.fadeOut(\"fast\", function() {\n                        templates.replaceNodeContents(this._region, html, js);\n                        this._region.fadeIn(\"fast\");\n                    }.bind(this));\n                }.bind(this)).fail(notification.exception);\n            }\n            .bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    return UserInfo;\n});\n"],"file":"grading_navigation_user_info.min.js"}