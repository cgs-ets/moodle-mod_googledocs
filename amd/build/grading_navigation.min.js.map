{"version":3,"sources":["../src/grading_navigation.js"],"names":["define","$","notification","ajax","str","GoogledocSaveGrading","GradingNavigation","selector","_regionSelector","_region","_users","_firstLoadUsers","console","log","_loadAllUsers","find","on","_handlePreviousUser","bind","_handleNextUser","_refreshView","prototype","_isLoading","_filters","_lastFilters","select","googledocid","attr","groupid","call","methodname","args","done","_setUsers","fail","exception","users","JSON","parse","e","preventDefault","_handlePreviousUser_helper","userid","filter","val","parseInt","currentSelectionid","prev","removeAttr","lastSelection","_handleNextUser_helper","next","update_url","url","URL","window","location","searchParams","get","set","history","replaceState","event","fromhandleUser","target","value","document","trigger","get_user_by_id","data","response","region","fadeOut","replaceWith","html","show","init","reason","_handleChangeUser","change","get_strings","key","component","strs","confirm","isNaN"],"mappings":"AAwBAA,OAAM,qCAAC,CAAC,QAAD,CAAW,mBAAX,CAAgC,WAAhC,CAA6C,UAA7C,CAAyD,6BAAzD,CAAD,CACF,SAASC,CAAT,CAAYC,CAAZ,CAA0BC,CAA1B,CAAgCC,CAAhC,CAAqCC,CAArC,CAA2D,CAQ3D,GAAIC,CAAAA,CAAiB,CAAG,SAASC,CAAT,CAAmB,CACvC,KAAKC,eAAL,CAAuBD,CAAvB,CACA,KAAKE,OAAL,CAAeR,CAAC,CAACM,CAAD,CAAhB,CACA,KAAKG,MAAL,CAAc,EAAd,CACA,KAAKC,eAAL,IACAC,OAAO,CAACC,GAAR,CAAY,uBAAZ,EAEA,KAAKC,aAAL,GAIA,KAAKL,OAAL,CAAaM,IAAb,CAAkB,iCAAlB,EAAmDC,EAAnD,CAAsD,OAAtD,CAA+D,KAAKC,mBAAL,CAAyBC,IAAzB,CAA8B,IAA9B,CAA/D,EACA,KAAKT,OAAL,CAAaM,IAAb,CAAkB,6BAAlB,EAA+CC,EAA/C,CAAkD,OAAlD,CAA2D,KAAKG,eAAL,CAAqBD,IAArB,CAA0B,IAA1B,CAA3D,EACA,KAAKT,OAAL,CAAaM,IAAb,CAAkB,+BAAlB,EAAiDC,EAAjD,CAAoD,QAApD,CAA8D,KAAKI,YAAL,CAAkBF,IAAlB,CAAuB,IAAvB,CAA9D,CAEH,CAfD,CAkBAZ,CAAiB,CAACe,SAAlB,CAA4BC,UAA5B,IAGAhB,CAAiB,CAACe,SAAlB,CAA4Bb,eAA5B,CAA8C,IAA9C,CAGAF,CAAiB,CAACe,SAAlB,CAA4BE,QAA5B,CAAuC,IAAvC,CAGAjB,CAAiB,CAACe,SAAlB,CAA4BX,MAA5B,CAAqC,IAArC,CAGAJ,CAAiB,CAACe,SAAlB,CAA4BZ,OAA5B,CAAsC,IAAtC,CAGAH,CAAiB,CAACe,SAAlB,CAA4BG,YAA5B,CAA2C,EAA3C,CASAlB,CAAiB,CAACe,SAAlB,CAA4BP,aAA5B,CAA4C,UAAW,IAC/CW,CAAAA,CAAM,CAAG,KAAKhB,OAAL,CAAaM,IAAb,CAAkB,2BAAlB,CADsC,CAE/CW,CAAW,CAAGD,CAAM,CAACE,IAAP,CAAY,kBAAZ,CAFiC,CAG/CC,CAAO,CAAGH,CAAM,CAACE,IAAP,CAAY,cAAZ,CAHqC,CAKnDxB,CAAI,CAAC0B,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,iCADL,CAEPC,IAAI,CAAE,CAACL,WAAW,CAAEA,CAAd,CAA2BE,OAAO,CAAEA,CAApC,CAFC,CAGPI,IAAI,CAAE,KAAKC,SAAL,CAAef,IAAf,CAAoB,IAApB,CAHC,CAIPgB,IAAI,CAAEhC,CAAY,CAACiC,SAJZ,CAAD,CAAV,EAMA,QACH,CAZD,CAoBA7B,CAAiB,CAACe,SAAlB,CAA4BY,SAA5B,CAAwC,SAASG,CAAT,CAAgB,CACpD,KAAK1B,MAAL,CAAc2B,IAAI,CAACC,KAAL,CAAWF,CAAK,CAACA,KAAjB,CACjB,CAFD,CAYA9B,CAAiB,CAACe,SAAlB,CAA4BJ,mBAA5B,CAAkD,SAASsB,CAAT,CAAY,CAC1DA,CAAC,CAACC,cAAF,GACA,KAAKC,0BAAL,CAAgCF,CAAhC,EACA,GAAIG,CAAAA,CAAM,CAAGzC,CAAC,CAAC,6BAAD,CAAD,CAAiC0C,MAAjC,CAAwC,WAAxC,EAAqDC,GAArD,EAAb,CACAF,CAAM,CAAGG,QAAQ,CAACH,CAAD,CAAS,EAAT,CAAjB,CACA,GAAa,CAAT,CAAAA,CAAJ,CAAgB,CACb,KAAKtB,YAAL,CAAkBmB,CAAlB,CAAqBG,CAArB,IACF,CAEJ,CATD,CAWApC,CAAiB,CAACe,SAAlB,CAA4BoB,0BAA5B,CAAyD,UAAY,CACjE,GAAIK,CAAAA,CAAkB,CAAG7C,CAAC,CAAC,gCAAD,CAAD,CAAoC2C,GAApC,EAAzB,CACA3C,CAAC,CAAC,gCAAD,CAAD,CAAoC8C,IAApC,GAA2CpB,IAA3C,CAAgD,UAAhD,CAA4D,UAA5D,EACA1B,CAAC,8CAAuC6C,CAAvC,OAAD,CAAgEE,UAAhE,CAA2E,UAA3E,CACH,CAJD,CAYA1C,CAAiB,CAACe,SAAlB,CAA4BF,eAA5B,CAA8C,SAASoB,CAAT,CAAmB,CAC7DA,CAAC,CAACC,cAAF,GAD6D,GAGzDM,CAAAA,CAAkB,CAAG7C,CAAC,CAAC,gCAAD,CAAD,CAAoC2C,GAApC,EAHoC,CAIzDK,CAAa,CAAGhD,CAAC,CAAC,wCAAD,CAAD,CAA4C2C,GAA5C,EAJyC,CAK7D,GAAIE,CAAkB,EAAIG,CAA1B,CAAyC,CACrC,KAAKC,sBAAL,CAA4BJ,CAA5B,EACA,GAAIJ,CAAAA,CAAM,CAAGzC,CAAC,CAAC,6BAAD,CAAD,CAAiC0C,MAAjC,CAAwC,WAAxC,EAAqDC,GAArD,EAAb,CACA,KAAKxB,YAAL,CAAkBmB,CAAlB,CAAqBG,CAArB,IACH,CACJ,CAVD,CAYApC,CAAiB,CAACe,SAAlB,CAA4B6B,sBAA5B,CAAqD,SAASJ,CAAT,CAA6B,CAC9E7C,CAAC,CAAC,sCAAD,CAAD,CAA0CkD,IAA1C,GAAiDxB,IAAjD,CAAsD,UAAtD,CAAkE,UAAlE,EACA1B,CAAC,8CAAuC6C,CAAvC,OAAD,CAAgEE,UAAhE,CAA2E,UAA3E,CACH,CAHD,CAKA1C,CAAiB,CAACe,SAAlB,CAA4B+B,UAA5B,CAAyC,SAAUV,CAAV,CAAkB,CACvD,GAAIW,CAAAA,CAAG,CAAG,GAAIC,CAAAA,GAAJ,CAAQC,MAAM,CAACC,QAAf,CAAV,CACAH,CAAG,CAACI,YAAJ,CAAiBC,GAAjB,CAAqB,QAArB,EACAL,CAAG,CAACI,YAAJ,CAAiBE,GAAjB,CAAqB,QAArB,CAA+BjB,CAA/B,EAEAa,MAAM,CAACK,OAAP,CAAeC,YAAf,CAA4B,EAA5B,CAAgC,EAAhC,CAAoCR,CAApC,CACH,CAND,CAgBA/C,CAAiB,CAACe,SAAlB,CAA4BD,YAA5B,CAA2C,SAAS0C,CAAT,CAAgBpB,CAAhB,CAAwBqB,CAAxB,CAAwC,CAE/ErB,CAAM,CAAGqB,CAAc,CAAGrB,CAAH,CAAYoB,CAAK,CAACE,MAAN,CAAaC,KAAhD,CACAvB,CAAM,CAAGG,QAAQ,CAACH,CAAD,CAAS,EAAT,CAAjB,CAEA,GAAa,CAAT,CAAAA,CAAJ,CAAiB,CACbzC,CAAC,CAACiE,QAAD,CAAD,CAAYC,OAAZ,CAAoB,cAApB,CAAoCzB,CAApC,EACApC,CAAiB,CAACe,SAAlB,CAA4B+B,UAA5B,CAAuCV,CAAvC,EACApC,CAAiB,CAACe,SAAlB,CAA4B+C,cAA5B,CAA2C1B,CAA3C,CACH,CAEJ,CAXD,CAaApC,CAAiB,CAACe,SAAlB,CAA4B+C,cAA5B,CAA6C,SAAU1B,CAAV,CAAkB,CAE3D,GAAIhB,CAAAA,CAAW,CAAUzB,CAAC,CAAC,6BAAD,CAAD,CAA+BoE,IAA/B,CAAoC,aAApC,CAAV,GAAf,CACClE,CAAI,CAAC0B,IAAL,CAAU,CAAC,CACRC,UAAU,CAAE,6CADJ,CAERC,IAAI,CAAE,CACFW,MAAM,CAAGA,CADP,CAEFhB,WAAW,CAAEA,CAFX,CAFE,CAMRM,IAAI,CAAC,cAASsC,CAAT,CAAkB,CAEnB,GAAIC,CAAAA,CAAM,CAAGtE,CAAC,CAAC,yBAAD,CAAd,CAEAsE,CAAM,CAACC,OAAP,CAAe,GAAf,CAAoB,UAAW,CAC3BD,CAAM,CAACE,WAAP,CAAmBH,CAAQ,CAACI,IAA5B,EACAH,CAAM,CAACI,IAAP,GACA1E,CAAC,CAAC,YAAD,CAAD,CAAgBe,EAAhB,CAAmB,QAAnB,CAA6BX,CAAoB,CAACuE,IAArB,EAA7B,CACH,CAJD,CAKH,CAfO,CAgBT1C,IAAI,CAAE,cAAS2C,CAAT,CAAiB,CAClBjE,OAAO,CAACC,GAAR,CAAY,8DAAZ,EACAD,OAAO,CAACC,GAAR,CAAYgE,CAAZ,CAEH,CApBO,CAAD,CAAV,CAsBJ,CAzBD,CA2BCvE,CAAiB,CAACe,SAAlB,CAA4ByD,iBAA5B,CAAgD,UAAW,IACpDrD,CAAAA,CAAM,CAAG,KAAKhB,OAAL,CAAaM,IAAb,CAAkB,2BAAlB,CAD2C,CAEpD2B,CAAM,CAAGG,QAAQ,CAACpB,CAAM,CAACmB,GAAP,EAAD,CAAe,EAAf,CAFmC,CAIxD,GAAI,KAAKtB,UAAT,CAAqB,CACjB,MACH,CAEDrB,CAAC,CAAC,mBAAD,CAAD,CAAuB8E,MAAvB,CAA8B,UAAW,CACrC9E,CAAC,CAAC,YAAD,CAAD,CAAgBoE,IAAhB,CAAqB,SAArB,IACH,CAFD,EAIA,GAAIpE,CAAC,CAAC,YAAD,CAAD,CAAgBoE,IAAhB,CAAqB,SAArB,CAAJ,CAAqC,CAEjCjE,CAAG,CAAC4E,WAAJ,CAAgB,CACZ,CAACC,GAAG,CAAE,gBAAN,CAAwBC,SAAS,CAAE,gBAAnC,CADY,CAEZ,CAACD,GAAG,CAAE,wBAAN,CAAgCC,SAAS,CAAE,gBAA3C,CAFY,CAGZ,CAACD,GAAG,CAAE,iBAAN,CAAyBC,SAAS,CAAE,gBAApC,CAHY,CAIZ,CAACD,GAAG,CAAE,QAAN,CAAgBC,SAAS,CAAE,MAA3B,CAJY,CAAhB,EAKGlD,IALH,CAKQ,SAASmD,CAAT,CAAe,CACnBjF,CAAY,CAACkF,OAAb,CAAqBD,CAAI,CAAC,CAAD,CAAzB,CAA8BA,CAAI,CAAC,CAAD,CAAlC,CAAuCA,CAAI,CAAC,CAAD,CAA3C,CAAgDA,CAAI,CAAC,CAAD,CAApD,CAAyD,UAAW,CAChElF,CAAC,CAACiE,QAAD,CAAD,CAAYC,OAAZ,CAAoB,cAApB,CAAoCzB,CAApC,CACH,CAFD,CAGH,CATD,CAUH,CAZD,IAYO,CACH,GAAI,CAAC2C,KAAK,CAAC3C,CAAD,CAAN,EAA2B,CAAT,CAAAA,CAAtB,CAAkC,CAC9BjB,CAAM,CAACE,IAAP,CAAY,eAAZ,CAA6Be,CAA7B,EAEAzC,CAAC,CAACiE,QAAD,CAAD,CAAYC,OAAZ,CAAoB,cAApB,CAAoCzB,CAApC,CACH,CACJ,CACJ,CA/BA,CAiCD,MAAOpC,CAAAA,CACV,CArNK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to handle changing users via the user selector in the header.\n *\n * @module     mod_assign/grading_navigation\n * @package    mod_assign\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/str', 'mod_googledocs/save_grading'],\n    function($, notification, ajax, str, GoogledocSaveGrading) {\n\n    /**\n     * GradingNavigation class.\n     *\n     * @class GradingNavigation\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var GradingNavigation = function(selector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._users = [];\n        this._firstLoadUsers = true;\n        console.log(\"GradingNavigation....\");\n       \n        this._loadAllUsers();\n\n        // We do not allow navigation while ajax requests are pending.\n        // Attach listeners to the select and arrow buttons.\n        this._region.find('[data-action=\"previous-user\"]').on('click', this._handlePreviousUser.bind(this));\n        this._region.find('[data-action=\"next-user\"]').on('click', this._handleNextUser.bind(this));\n        this._region.find('[data-action=\"change-user\"]').on('change', this._refreshView.bind(this));\n\n    };\n\n    /** @type {Boolean} Boolean tracking active ajax requests. */\n    GradingNavigation.prototype._isLoading = false;\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    GradingNavigation.prototype._regionSelector = null;\n\n    /** @type {Array} The list of active filter keys */\n    GradingNavigation.prototype._filters = null;\n\n    /** @type {Array} The list of users */\n    GradingNavigation.prototype._users = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    GradingNavigation.prototype._region = null;\n\n    /** @type {String} Last active filters */\n    GradingNavigation.prototype._lastFilters = '';\n\n    /**\n     * Load the list of all users for this assignment.\n     * and their file info.\n     * @private\n     * @method _loadAllUsers\n     * @return {Boolean} True if the user list was fetched.\n     */\n    GradingNavigation.prototype._loadAllUsers = function() {\n        var select = this._region.find('[data-action=change-user]');\n        var googledocid = select.attr('data-googledocid');\n        var groupid = select.attr('data-groupid');\n\n        ajax.call([{\n            methodname: 'mod_googledocs_get_participants',\n            args: {googledocid: googledocid, groupid: groupid},\n            done: this._setUsers.bind(this),\n            fail: notification.exception\n        }]);\n        return true;\n    };\n\n    /**\n     *      *\n     * @private\n     * @method _usersLoaded\n     * @param {Array} users\n     */\n    GradingNavigation.prototype._setUsers = function(users) {\n        this._users = JSON.parse(users.users);\n    };\n    \n\n    /**\n     * Change to the previous user in the grading list.\n     *\n     * @private\n     * @method _handlePreviousUser\n     * @param {Event} e\n     */\n    GradingNavigation.prototype._handlePreviousUser = function(e) {\n        e.preventDefault();\n        this._handlePreviousUser_helper(e);\n        var userid = $(\"select.custom-select option\").filter(\":selected\").val();\n        userid = parseInt(userid, 10);\n        if (userid > 0) {\n           this._refreshView(e, userid, true);\n        }\n\n    };\n    \n    GradingNavigation.prototype._handlePreviousUser_helper = function(e) {\n        var currentSelectionid = $('.custom-select option:selected').val();\n        $('.custom-select option:selected').prev().attr('selected', 'selected');\n        $(`select.custom-select option[value='${currentSelectionid}']`).removeAttr('selected');\n    }\n    \n    /**\n     * Change to the next user in the grading list.\n     *\n     * @param {Event} e\n     * @param {Boolean} saved Has the form already been saved? Skips checking for changes if true.\n     */\n    GradingNavigation.prototype._handleNextUser = function(e, saved) {\n        e.preventDefault();\n\n        var currentSelectionid = $('.custom-select option:selected').val();\n        var lastSelection = $('select.custom-select option:last-child').val();\n        if (currentSelectionid != lastSelection) {\n            this._handleNextUser_helper(currentSelectionid);\n            var userid = $(\"select.custom-select option\").filter(\":selected\").val();\n            this._refreshView(e, userid, true);\n        };\n    };\n    \n    GradingNavigation.prototype._handleNextUser_helper = function(currentSelectionid) {\n        $('select.custom-select option:selected').next().attr('selected', 'selected');\n        $(`select.custom-select option[value='${currentSelectionid}']`).removeAttr('selected');\n    };\n    \n    GradingNavigation.prototype.update_url = function (userid) {\n        var url = new URL(window.location);\n        url.searchParams.get('userid');\n        url.searchParams.set('userid', userid);\n        // We do this so a browser refresh will return to the same user.\n        window.history.replaceState({}, \"\", url);\n    };\n\n    /**\n     * Respond to a user-changed event by updating the view.\n     *\n     * @private\n     * @method _refreshView\n     * @param {Event} event\n     * @param {String} userid\n     */\n    GradingNavigation.prototype._refreshView = function(event, userid, fromhandleUser) {\n\n        userid = fromhandleUser ? userid : event.target.value; \n        userid = parseInt(userid, 10);\n\n        if (userid > 0 ) {\n            $(document).trigger('user-changed', userid);   // Refresh name\n            GradingNavigation.prototype.update_url(userid);\n            GradingNavigation.prototype.get_user_by_id(userid);\n        }\n        \n    };\n\n    GradingNavigation.prototype.get_user_by_id = function (userid) {\n        \n        var googledocid = String($('[data-region=\"user-info\"]').data('googledocid'))\n         ajax.call([{\n            methodname: 'mod_googledocs_get_next_participant_details',\n            args: {\n                userid : userid,\n                googledocid: googledocid\n            },\n            done:function(response){\n\n                var region = $('[data-region=\"grade\"]');\n\n                region.fadeOut(300, function() {\n                    region.replaceWith(response.html);\n                    region.show();\n                    $(\"#gradeform\").on('submit', GoogledocSaveGrading.init()); //Re-attach the event\n                });\n            },\n           fail: function(reason) {\n                console.log('mod_googledocs_get_participant_by_id. Unable to get elements');\n                console.log(reason);\n\n            }\n        }]);\n    };\n    \n     GradingNavigation.prototype._handleChangeUser = function() {\n        var select = this._region.find('[data-action=change-user]');\n        var userid = parseInt(select.val(), 10);\n\n        if (this._isLoading) {\n            return;\n        }\n        \n        $(\"#gradeform :input\").change(function() {\n            $(\"#gradeform\").data(\"changed\",true);\n        });\n        \n        if ($(\"#gradeform\").data(\"changed\")) {\n            // Form has changes, so we need to confirm before switching users.\n            str.get_strings([\n                {key: 'unsavedchanges', component: 'mod_googledocs'},\n                {key: 'unsavedchangesquestion', component: 'mod_googledocs'},\n                {key: 'saveandcontinue', component: 'mod_googledocs'},\n                {key: 'cancel', component: 'core'},\n            ]).done(function(strs) {\n                notification.confirm(strs[0], strs[1], strs[2], strs[3], function() {\n                    $(document).trigger('save-changes', userid);\n                });\n            });\n        } else {\n            if (!isNaN(userid) && userid > 0) {\n                select.attr('data-selected', userid);\n\n                $(document).trigger('user-changed', userid);\n            }\n        }\n    };\n\n    return GradingNavigation;\n});\n"],"file":"grading_navigation.min.js"}